<div class="modal fade" id="sysview_findConn_modal">
    <div class="modal-dialog modal-lg" style="transition: width 0.7s;">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-10">
                        <div id="sysview_findConn_cktArea" class="box box-primary">
                            <div class="box-header with-border">
                                <h3 class="box-title">LIST OF CKTS:</h3>
                            </div>
                            <div class="box-body">
                                <table id="sysview_findConn_cktTable" class="table table-striped table-bordered table-hover" style="width:100%;">
                                    <thead>
                                        <tr>
                                            <th>CKID</th>
                                            <th>CLS</th>
                                            <th>ADSR</th>
                                            <th>PROT</th>
                                            <th>ORDNO</th>
                                            <th>MLO</th>
                                            <th>DATE</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                    
                        </div>

                        <div id="sysview_findConn_cktconArea" class="box box-primary" style="display:none">
                            <div class="box-header with-border">
                                <h3 class="box-title">LIST OF CONNECTIONS:</h3>
                            </div>
                            <div class="box-body">
                                <table id="sysview_findConn_cktconTable" class="table table-striped table-bordered table-hover" style="width:100%;">
                                    <thead>
                                        <tr>
                                            <th rowspan="2">ID</th>
                                            <th rowspan="2">CONTYP</th>
                                            <th colspan="3">FROM(X):</th>
                                            <th colspan="3">TO(Y):</th>
                                        </tr>
                                        <tr>
                                            <th>PORT</th>
                                            <th>PSTA</th>
                                            <th>FAC(X)</th>
                                            <th>PORT</th>
                                            <th>PSTA</th>
                                            <th>FAC(Y)</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                    
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button id="sysview_findConn_submit" type="button" class="btn btn-primary" style="width:100%; margin-bottom: 5px">Submit</button>
                        <button id="sysview_findConn_goBack" type="button" class="btn btn-primary" style="width:100%; margin-bottom: 5px" disabled>Go Back</button>
                        <button type="button" class="btn btn-primary" data-dismiss="modal" style="width:100%; margin-bottom: 5px">Close</button>
                    </div>
                </div>

            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>

<script>
var sysview_findConn_ckid = "";

var sysview_findConn_cktDatatable = $('#sysview_findConn_cktTable').DataTable({
    "scrollY":        "100px",
    "data": [],
    "columns": [
        {"data":"ckid"},
        {"data":"cls"},
        {"data":"adsr"},
        {"data":"prot"},
        {"data":"ordno"},
        {"data":"mlo"},
        {
            "data":"date",
            "render": function(data) {
                if(!data) return data;
                let date = moment(data,'YYYY-MM-DD HH:mm:ss').format('MM-DD-YYYY HH:mm:ss');
                return date;
            }
        }
    ],
    "order": [[ 6, "desc" ]]
});
  
var sysview_findConn_cktconDatatable = $("#sysview_findConn_cktconTable").DataTable({
    "scrollY":        "100px",
    // "scrollCollapse": true,
    "data" : [],
    "columns" : [
        {"data":"idx"},
        {"data":"ctyp"},
        {"data":"fport"},
        {"data":"fpsta"},
        {"data":"ffac"},
        {"data":"tport"},
        {"data":"tpsta"},
        {"data":"tfac"}
    ],
    "order" : [[0, "asc"]]

})
    
function sysview_findConn_queryCkid() {
    $.ajax({
        type: 'POST',
        url: ipcDispatch,
        data: {
            "api":    "ipcProv",
            "act":    "queryCkid",
            "user":   user.uname,
            "grp":    user.grp,
            "ugrp":   user.ugrp,
        },
        dataType: 'json'
    }).done(function(data) {
        let res = [];
        if(data.hasOwnProperty('rows')){
            res = data.rows;
        }
        sysview_findConn_cktDatatable.clear().draw();
        sysview_findConn_cktDatatable.rows.add(res);
        sysview_findConn_cktDatatable.columns.adjust().draw();
    });
}

function sysview_findConn_queryCktConByCkid(ckid) {
    $.ajax({
        type:'post',
        url:ipcDispatch,
        data: {
            api: 'ipcProv',
            act: 'queryCktconByCkid',
            user: user.uname,   
            grp:  user.grp,
            ugrp: user.ugrp,
            ckid: ckid
        },
        dataType: 'json',
    }).done(function(data){
        let res = [];
        if(data.hasOwnProperty('rows'))
            res = data.rows;

        sysview_findConn_cktconDatatable.clear().draw();
        sysview_findConn_cktconDatatable.rows.add(res);
        sysview_findConn_cktconDatatable.columns.adjust().draw();
    })
}

function sysview_fincConn_resetModal(){
    $("#sysview_findConn_cktArea").show()
    $("#sysview_findConn_cktconArea").hide()
    $("#sysview_findConn_submit").prop("disabled",false)
    $("#sysview_findConn_goBack").prop("disabled", true)
    sysview_findConn_ckid = "";
    sysview_findConn_cktDatatable.clear().draw();
    sysview_findConn_cktconDatatable.clear().draw();
}

$("#find_conn_btn").click(function(){
    sysview_fincConn_resetModal();
    $("#sysview_findConn_modal").modal();
})

$('#sysview_findConn_modal').on('shown.bs.modal', function (e) {
    sysview_findConn_queryCkid()
})

$("#sysview_findConn_submit").click(function(){
    if(sysview_findConn_ckid === "")
        return;
    $("#sysview_findConn_submit").prop("disabled", true);
    $("#sysview_findConn_goBack").prop("disabled", false);
    $("#sysview_findConn_cktArea").hide();
    $("#sysview_findConn_cktconArea").show();
    sysview_findConn_queryCktConByCkid(sysview_findConn_ckid)
})

$("#sysview_findConn_goBack").click(function(){
    $("#sysview_findConn_submit").prop("disabled", false);
    $("#sysview_findConn_goBack").prop("disabled", true);
    $("#sysview_findConn_cktArea").show();
    $("#sysview_findConn_cktconArea").hide();
})

$(document).on('click', '#sysview_findConn_cktTable tbody tr', function() {
    let data = sysview_findConn_cktDatatable.row(this).data();
    if(data == undefined)
        return;   
    // give selected class
    $('#sysview_findConn_cktTable tbody tr').removeClass('bg-primary');
    $(this).addClass('bg-primary');

    sysview_findConn_ckid = data.ckid;

});
     
$(document).on('click', '#sysview_findConn_cktconArea tbody tr', function() {
    let data = sysview_findConn_cktconDatatable.row(this).data();
    if(data == undefined)
        return;   
    // give selected class
    $('#sysview_findConn_cktconArea tbody tr').removeClass('bg-primary');
    $(this).addClass('bg-primary');

    let connect = [data.fport,data.tport]
    connect.forEach(port => {
        let portExtract = port.split('-');
        let node = portExtract[0];
        let slot = portExtract[1];
        let ptyp = portExtract[2].toLowerCase();
        let pnum = portExtract[3];

        $(".node-tab[node_id='"+node+"'][ptyp='"+ptyp+"']").find('a').trigger('click');
        $(".mio-btn[slot='"+slot+"'][ptyp='"+ptyp+"']").trigger('click');
        let portRangeIndex = Math.floor((pnum-1)/25);
        $(".port-range-btn[index='"+portRangeIndex+"'][ptyp='"+ptyp.toLowerCase()+"']").trigger('click');
        let portGrid_id = 0;
        if(pnum > 25) 
            portGrid_id = pnum - 25;
        else 
            portGrid_id = pnum;
        if(portGrid_id > 0) {
            $(".port-grid[ptyp='"+ptyp+"'] > .port-box").removeClass('addBorder')
            $(".port-grid[ptyp='"+ptyp+"'] > .port-box[grid_num='"+portGrid_id+"']").addClass('addBorder')
        }
    });

});
        

</script>